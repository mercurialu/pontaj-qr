<!DOCTYPE html>
<html lang="ro">
<head>
<title>Pontaj QR Automat</title>
</head>
<body>
<h3 id="status">Pontaj în curs...</h3>

<script>
window.onload=()=>{
  const params = new URLSearchParams(window.location.search);
  const angajat = params.get('angajat');
  const tip = params.get('tip');

  if (angajat && tip) {
    // Încearcă să obțină locația GPS
    navigator.geolocation.getCurrentPosition(
      (pos) => {
        const locatie = pos.coords.latitude.toFixed(7) + "," + pos.coords.longitude.toFixed(7); // Locație precisă
        const ip = "";  // Vom folosi IP-ul din altă sursă

        // Verificăm dacă IP-ul există deja
        fetch('https://api.ipify.org?format=json').then(response => response.json()).then(ipData => {
          const ip = ipData.ip || "0.0.0.0";  // Fallback în caz că IP-ul nu se poate obține

          const url = `https://script.google.com/macros/s/AKfycbw4yjy2vfJnG0vjw5ski0r2w-61fD7jimVKKG3cXnUV6xshwCIYnhXmKsiZDpyjaRrAjg/exec?angajat=${encodeURIComponent(angajat)}&tip=${encodeURIComponent(tip)}&ip=${ip}&locatie=${locatie}`;

          fetch(url)
            .then(() => document.getElementById('status').innerText = "✅ Pontaj înregistrat!")
            .catch(() => document.getElementById('status').innerText = "❌ Eroare pontaj!");
        });
      },
      () => {
        // Fallback în cazul în care nu putem obține locația GPS
        document.getElementById('status').innerText = "❌ GPS indisponibil, folosim locația prin IP!";
        
        fetch('https://api.ipify.org?format=json').then(response => response.json()).then(ipData => {
          const ip = ipData.ip;
          
          fetch(`https://ipinfo.io/${ip}/json?token=30adda3f305374`)  // Folosim locația prin IP
            .then(response => response.json())
            .then(data => {
              const locatieIP = data.loc || "0.0,0.0";  // Dacă locația IP nu este disponibilă, folosim 0.0,0.0
              const urlFallback = `https://script.google.com/macros/s/AKfycbw4yjy2vfJnG0vjw5ski0r2w-61fD7jimVKKG3cXnUV6xshwCIYnhXmKsiZDpyjaRrAjg/exec?angajat=${encodeURIComponent(angajat)}&tip=${encodeURIComponent(tip)}&ip=${ip}&locatie=${locatieIP}`;

              fetch(urlFallback)
                .then(() => document.getElementById('status').innerText = "✅ Pontaj înregistrat cu locație prin IP!")
                .catch(() => document.getElementById('status').innerText = "❌ Eroare pontaj!");
            });
        });
      },
      { enableHighAccuracy: true, maximumAge: 0 }
    );
  } else {
    document.getElementById('status').innerText = "⚠️ QR invalid!";
  }
};
</script>
</body>
</html>
